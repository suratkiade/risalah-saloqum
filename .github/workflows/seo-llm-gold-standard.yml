name: seo-llm-gold-standard

on:
  push:
    branches: ["main"]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: "seo-llm-gold-standard-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Git settings (avoid line-ending noise)
        run: |
          git config --global core.autocrlf false
          git config --global core.eol lf

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            requirements.txt

      - name: Install validation dependencies (network-resilient)
        run: |
          set -euo pipefail
          NEED_INSTALL=0
          python -c 'import importlib.util,sys; mods=["mkdocs","yaml","pymdownx","mkdocs_material_extensions"]; missing=[m for m in mods if importlib.util.find_spec(m) is None]; sys.exit(1 if missing else 0)' || NEED_INSTALL=1
 codex/audit-forensic-wiki-for-standards-compliance-8wz5yj


          if [ "$NEED_INSTALL" -eq 1 ]; then
            python -m pip install --upgrade pip
            python -m pip install mkdocs==1.6.1 mkdocs-material==9.7.1 mkdocs-material-extensions==1.3.1 pymdown-extensions==10.11.2 pyyaml==6.0.2
          fi

          python -m pip install --no-build-isolation ./tools/mkdocs_sitemap

          if [ "$NEED_INSTALL" -eq 1 ]; then
            python -m pip install --upgrade pip
            python -m pip install mkdocs==1.6.1 mkdocs-material==9.7.1 mkdocs-material-extensions==1.3.1 pymdown-extensions==10.11.2 pyyaml==6.0.2
          fi

          python -m pip install --no-build-isolation ./tools/mkdocs_sitemap

      - name: Preflight script forensic audit
        run: |
          set -euo pipefail
          python tools/audit_repo_scripts.py

      - name: Validate release artifacts
        run: |
          set -euo pipefail
          python tools/validate_release_artifacts.py

      - name: Validate JSON-LD
        run: |
          set -euo pipefail
          python tools/validate_jsonld.py

      - name: Validate site entrypoints
        run: |
          set -euo pipefail
          python tools/validate_site_entrypoints.py

      - name: Sync observability ledger
        run: |
          set -euo pipefail
          python tools/sync_observability_ledger.py

      - name: Validate semantic readiness
        run: |
          set -euo pipefail
          python tools/validate_semantic_readiness.py

      - name: Validate SEO+LLM standards
        run: |
          set -euo pipefail
          python tools/validate_seo_llm_standards.py

      - name: MkDocs build
        run: |
          set -euo pipefail
          mkdocs build --strict
